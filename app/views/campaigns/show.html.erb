<div class="row row-0">
  <div class="col-md-10 col-md-offset-1 col-xs-10 col-xs-offset-1">
    <div class="page-header">
      <div class="row">
        <div class="col-md-4">
          <h1 class="border-left"><%= @campaign.name %></h1>
        </div>
        <div class="col-md-4 col-md-offset-4 col-xs-4 col-xs-offset-1 col-sm-5">
          <%= link_to campaigns_path, class: 'btn btn-default pink-show' do %>
            <%= t("views.campaigns.campaigns_show.campaigns_summary.back_button") %>
          <% end %>
          <%= link_to edit_campaign_path(id: @campaign.id), class: 'btn btn-default pink-show' do %>
            <%= t("views.campaigns.campaigns_show.campaigns_summary.edit_button") %>
            <span class="glyphicon glyphicon-pencil"></span>
          <% end %>
        </div>
      </div>
    </div>

    <div class="row margin-bot">
      <div class="col-md-3 align-center">
        <%= image_tag(@campaign.logo.real_ftp_url, class: "logo") %>
      </div>
      <div class="col-md-3 align-center">
        <p class="text-pink"><%= t("views.campaigns.campaigns_show.campaigns_summary.company") %></p>
        <p class="text-gray"><%= @campaign.sender_name %></p>
      </div>
      <div class="col-md-3 align-center">
        <p class="text-pink"><%= t("views.campaigns.campaigns_show.campaigns_summary.sender") %></p>
        <p class="text-gray"><%= @campaign.sender_email %></p>
      </div>
      <div class="col-md-3 align-center">
        <p class="text-pink"><%= t("views.campaigns.campaigns_show.campaigns_summary.creation_date") %></p>
        <p class="text-gray"><%= @campaign.created_at.strftime("%d-%m-%Y") %></p>
      </div>
    </div>

    <div class="row text-center contact-stats">
      <div class="col-md-4">
        <div class="row">
          <div class="col-md-10 contact-stats-box">
            <h4><%= t("views.campaigns.campaigns_show.campaigns_summary.sent_stats") %></h4>
            <span class="contact-stat"><%= @campaign.mails_sent %></span>
            <span class="badge"><%= number_to_percentage(@campaign.percentage_sent, precision: 1) %></span>
          </div>
          <div class="col-md-10 contact-stats-box">
            <h4><%= t("views.campaigns.campaigns_show.campaigns_summary.not_sent_stats") %></h4>
            <span class="contact-stat"><%= @campaign.mails_not_sent %></span>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="row">
          <div class="col-md-10 contact-stats-box">
            <h4><%= t("views.campaigns.campaigns_show.campaigns_summary.answers_stats") %></h4>
            <span class="contact-stat"><%= @campaign.mails_answered %></span>
            <span class="badge"><%= number_to_percentage(@campaign.percentage_answered, precision: 1) %></span>
          </div>
          <div class="col-md-10 contact-stats-box">
            <h4><%= t("views.campaigns.campaigns_show.campaigns_summary.unanswered_stats") %></h4>
            <span class="contact-stat"><%= @campaign.mails_not_answered %></span>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="row">
          <div class="col-md-10 contact-stats-box">
            <h4><%= t("views.campaigns.campaigns_show.campaigns_summary.unsuscribe_stats") %></h4>
            <span class="contact-stat unsubscribed-stat"><%= @campaign.unsubscribes %></span>
            <span class="badge"><%= number_to_percentage(@campaign.percentage_unsubscribed, precision: 1) %></span>
          </div>
          <div class="col-md-10 contact-stats-box">
            <% campaign_last_sent = (@campaign.last_sent)? @campaign.last_sent.strftime("%d-%m-%Y") : 'Sin enviar' %>
            <h4><%= t("views.campaigns.campaigns_show.campaigns_summary.last_sent") %></h4>
            <span class="contact-stat last-sent-stat"><%= campaign_last_sent %></span>
          </div>
        </div>
      </div>
    </div>

    <br><br><br>

    <div id="nps_score" class="shadow-box"></div>
    <%#= javascript_tag do %>
      <%#=
        graph_generate(
          'nps_score',
          data: {
            x: 'x',
            columns: [
              ['x'] + @nps.dates,
              ['NPS'] + @nps.nps,
              ['Detractors'] + @nps.detractors,
              ['Passives'] + @nps.passives,
              ['Promoters'] + @nps.promoters
            ],
            axes: {
              'NPS' => 'y'
            }
          },
          legend: {
            show: false
          },
          axis: {
            x: {
              type: 'category'
            },
            y: {
              max: 95,
              min: -95
            }
          }
        )
      %>
    <%# end %>

    <h1 class="border-left" id="contactos"><%= t("views.campaigns.campaigns_show.campaigns_import.contacts_subtitle") %></h1>

    <% if @campaign.last_sent.nil? %>
      <div class="row">
        <h5><%= t("views.campaigns.campaigns_show.campaigns_import.contacts_instructions") %></h5>
        <h5><%= t("views.campaigns.campaigns_show.campaigns_import.contacts_instructions1") %></h5>
        <h5><%= t("views.campaigns.campaigns_show.campaigns_import.contacts_instructions2") %></h5>
        <table class="table table-striped table-bordered table-hover ">
          <thead>
            <tr>
              <th class='back-gray'><h5><%= t("views.campaigns.campaigns_show.campaigns_import.table_email") %></h5></th>
              <% @topics.each do |topic| %>
                <th class='back-gray'><%= Campaign.translated_topics[topic]  %></th>
              <% end %>
              <th class='back-gray'><h5><%= t("views.campaigns.campaigns_show.campaigns_import.table_name") %></h5></th>
            </tr>
          </thead>
        </table>

        <h5><%= t("views.campaigns.campaigns_show.campaigns_import.contacts_instructions3") %></h5>
        <h5><%= t("views.campaigns.campaigns_show.campaigns_import.contacts_instructions4") %></h5>
        <h5><%= t("views.campaigns.campaigns_show.campaigns_import.contacts_reminder") %></h5>
      </div>
      <br><br><br>
    <% end %>

    <br>

    <div class="row">
      <div class="col-md-3 col-sm-3">
        <%= link_to campaign_template_path(id: @campaign.id, format: 'csv'), class: 'csv-template-button' do %>
          <%= image_tag 'csv.png', class: 'csv-template-button-img' %>
          <br>
          <%= t("views.campaigns.campaigns_show.campaigns_import.download_button") %>
        <% end %>
      </div>
      <div class="col-md-4 col-sm-4">
        <%= form_for :campaign, url: { controller: 'campaigns', action: 'upload_csv' } do |f| %>
        <div class="form-group">
          <%= f.hidden_field :id %>
          <%= f.file_field :file, accept: '.csv', placeholder: 'sin archivo', class: 'inputfile' %>
          <%= f.label :file, 'Importar contactos' , class: "control-label" do %>
          <figure><svg xmlns="http://www.w3.org/2000/svg" width="20" height="17" viewBox="0 0 20 17"><path d="M10 0l-5.2 4.9h3.3v5.1h3.8v-5.1h3.3l-5.2-4.9zm9.3 11.5l-3.2-2.1h-2l3.4 2.6h-3.5c-.1 0-.2.1-.2.1l-.8 2.3h-6l-.8-2.2c-.1-.1-.1-.2-.2-.2h-3.6l3.4-2.6h-2l-3.2 2.1c-.4.3-.7 1-.6 1.5l.6 3.1c.1.5.7.9 1.2.9h16.3c.6 0 1.1-.4 1.3-.9l.6-3.1c.1-.5-.2-1.2-.7-1.5z"/></svg></figure><span><%= t("views.campaigns.campaigns_show.campaigns_import.upload_message") %></span>
          <% end %>
          <br>
          <%= f.submit t("views.campaigns.campaigns_show.campaigns_import.upload_button"), class:"btn btn-default send-button import-contacts-btn" %>
          <br>
        </div>
        <% end %>
      </div>
      <div class="col-md-4 col-sm-4">
        <% if current_user.payment.plan_name == 'freelancer' && current_user.campaigns.last.id != @campaign.id %>
          <div class="text-center">
            <h4><%= t("views.campaigns.campaigns_show.campaigns_import.freelancer_warning") %></h4>
          </div>
          <% else %>
            <% unless @campaign.contacts.empty? %>
              <% if @campaign.valid_and_not_sent_contacts.count > 0 %>
                <%= link_to send_campaign_path(campaign_id: @campaign.id, sender_email: @campaign.sender_email), controller: 'campaigns', action: 'generate_campaign_mailing', class: 'btn btn-default send-button send-campaign', data: { confirm: t("views.campaigns.campaigns_show.campaigns_import.send_confirm") } do %><%= t("views.campaigns.campaigns_show.campaigns_import.send_button") %><br><%= t("views.campaigns.campaigns_show.campaigns_import.send_button2") %>
                <% end %>
              <% else %>
                <div class="text-center">
                  <h4><%= t("views.campaigns.campaigns_show.campaigns_import.upload_message1") %></h4>
                </div>
              <% end %>
            <% else %>
              <div class="text-center">
                <h4><%= t("views.campaigns.campaigns_show.campaigns_import.upload_message2") %></h4>
              </div>
            <% end %>
        <% end %>
      </div>
    </div>

    <br>
    <br>

    <% unless @campaign.invalid_contacts.empty? %>
      <h3><%= t("views.campaigns.campaigns_show.campaigns_invalid.invalid_title") %><small><%= t("views.campaigns.campaigns_show.campaigns_invalid.invalid_subtitle") %></small></h3>
      <div class="table-responsive shadow-box">
        <table class="table table-striped table-bordered table-hover ">
          <thead>
            <tr>
              <th class='back-gray'><%= t("views.campaigns.campaigns_show.campaigns_invalid.invalid_email") %></th>
              <% @topics.each do |topic| %>
                  <th class='back-gray'><%= Campaign.translated_topics[topic]  %></th>
              <% end %>
              <th class='back-gray'><%= t("views.campaigns.campaigns_show.campaigns_invalid.invalid_name") %></th>
              <th class='back-gray'></th>
              <th class='back-gray'></th>
            </tr>
          </thead>

          <tbody>
            <% @campaign.invalid_contacts.each do |contact| %>
              <% if contact.blacklist.nil? %>
                <tr>
                  <td><%= contact.email %></td>
                  <% unless @topics.empty? %>
                    <% contact.topics.sort.to_h.each do |t, v| %>
                      <td><%= v %></td>
                    <% end %>
                  <% end %>
                  <td><%= contact.name %></td>
                  <td><%= link_to '', edit_contact_path(id: contact.id), class: "black glyphicon glyphicon-pencil table-icons" %></td>
                  <td><%= link_to '', contact, class: "black glyphicon glyphicon-trash table-icons", method: :delete, data: { confirm: t("views.campaigns.campaigns_show.campaigns_invalid.invalid_delete") }%></td>
                </tr>
              <% end %>
            <% end %>
          </tbody>
        </table>
      </div>
    <% end %>

    <% unless @contacts_not_sent.empty? %>
      <h3><%= t("views.campaigns.campaigns_show.campaigns_not_sent.not_sent_title") %><small><%= t("views.campaigns.campaigns_show.campaigns_not_sent.not_sent_subtitle") %></small></h3>
      <div class="table-responsive shadow-box">
        <table class="table table-striped table-bordered table-hover not-sent-table">
          <thead>
            <tr>
              <th class='back-gray'><%= t("views.campaigns.campaigns_show.campaigns_not_sent.not_sent_email") %></th>
              <% @topics.each do |topic| %>
                
                  <th class='back-gray'><%= Campaign.translated_topics[topic]  %></th>
                
              <% end %>
              <th class='back-gray'><%= t("views.campaigns.campaigns_show.campaigns_not_sent.not_sent_name") %></th>
              <th class='back-gray'><%= t("views.campaigns.campaigns_show.campaigns_not_sent.not_sent_status") %></th>
              <th class='back-gray'></th>
              <th class='back-gray'></th>
            </tr>
          </thead>

          <tbody>
            <% @contacts_not_sent.each do |contact| %>
              <% if contact.blacklist.nil? %>
                <tr>
                  <td><%= contact.email %></td>
                  <% unless @topics.empty? %>
                    <% contact.topics.sort.to_h.each do |t, v| %>
                      <td><%= v %></td>
                    <% end %>
                  <% end %>
                  <td><%= contact.name %></td>
                  <td class="status"><%= contact.translated_status %></td>
                  <td><%= link_to '', edit_contact_path(id: contact.id), class: "black glyphicon glyphicon-pencil table-icons" %></td>
                  <td><%= link_to '', contact_path(id: contact.id, class: "black glyphicon glyphicon-trash table-icons", method: :delete, data: { confirm: t("views.campaigns.campaigns_show.campaigns_not_sent.not_sent_delete") }%></td>
                </tr>
              <% end %>
            <% end %>
          </tbody>
        </table>
      </div>
    <% end %>

    <% unless @contacts_sent_pendants_actives.empty? %>
      <h3><%= t("views.campaigns.campaigns_show.campaigns_pendants.pendants_title") %> <small><%= t("views.campaigns.campaigns_show.campaigns_pendants.pendants_subtitle") %></small></h3>
      <div class="table-responsive shadow-box">
        <table class="table table-striped table-bordered table-hover ">
          <thead>
            <tr>
              <th class='back-gray'><%= t("views.campaigns.campaigns_show.campaigns_pendants.pendants_email") %></th>
              <% @topics.each do |topic| %>
                
                  <th class='back-gray'><%= Campaign.translated_topics[topic]  %></th>
                
              <% end %>
              <th class='back-gray'><%= t("views.campaigns.campaigns_show.campaigns_pendants.pendants_name") %></th>
              <th class='back-gray'><%= t("views.campaigns.campaigns_show.campaigns_pendants.pendants_status") %></th>
              <th class='back-gray'><%= t("views.campaigns.campaigns_show.campaigns_pendants.pendants_send_date") %></th>
              <th class='back-gray'><%= t("views.campaigns.campaigns_show.campaigns_pendants.pendants_score") %></th>
              <th class='back-gray'><%= t("views.campaigns.campaigns_show.campaigns_pendants.pendants_comments") %></th>
            </tr>
          </thead>

          <tbody>
            <% @contacts_sent_pendants_actives.each do |contact| %>
              <% if contact.blacklist.nil? %>
                <tr>
                  <td><%= contact.email %></td>
                  <% unless @topics.empty? %>
                    <% contact.topics.sort.to_h.each do |t, v| %>
                      <td><%= v %></td>
                    <% end %>
                  <% end %>
                  <td><%= contact.name %></td>
                  <td class="status"><%= contact.translated_status %></td>
                  <td class="sent_date"><%= contact.sent_date&.strftime "%d/%m/%Y %H:%M".to_s %></td>
                  <td class="score"><%= contact.answer ? contact.answer.score : "Pendiente" %></td>
                  <td><%= contact.answer&.comment %></td>
                </tr>
              <% end %>
            <% end %>
          </tbody>
        </table>
      </div>
    <% end %>
  </div>
  <div class="col-md-1"></div>
</div>

<div class="row">
  <div class="col-md-12 col-md-offset-1">
    <%= will_paginate @contacts_sent_pendants_actives %>
  </div>
</div>

<script type="text/javascript">
  ;( function ( document, window, index )
  {
  var inputs = document.querySelectorAll( '.inputfile' );
  Array.prototype.forEach.call( inputs, function( input )
  {
    var label	 = input.nextElementSibling,
      labelVal = label.innerHTML;

    input.addEventListener( 'change', function( e )
    {
      var fileName = '';
      if( this.files && this.files.length > 1 )
        fileName = ( this.getAttribute( 'data-multiple-caption' ) || '' ).replace( '{count}', this.files.length );
      else
        fileName = e.target.value.split( '\\' ).pop();

      if( fileName )
        label.querySelector( 'span' ).innerHTML = fileName;
      else
        label.innerHTML = labelVal;
    });

    // Firefox bug fix
    input.addEventListener( 'focus', function(){ input.classList.add( 'has-focus' ); });
    input.addEventListener( 'blur', function(){ input.classList.remove( 'has-focus' ); });
  });
  }( document, window, 0 ));
</script>
