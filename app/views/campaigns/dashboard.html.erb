<%= provide :title, 'Dashboard' %>

<% if @no_campaigns %>
  <div class="row">
    <div class="col-md-8 col-md-offset-2">
      <h1>No existe ninguna campaña</h1>
      <h2>Crea una campaña y empieza a analizar tu información</h2>
    </div>
  </div>
<% else %>
  <% if @filters %>
    <div class="row">
      <div class="col-md-8 col-md-offset-2 well">
        <h4 class="text-center">Filtros activos</h4>
          <table class="table table-condensed">
            <thead>
              <tr>
                <td><h5>Período</h5></td>
                <td><h5>Campañas</h5></td>
                <td><h5>Topics</h5></td>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>
                  <span class="label label-default filter-label"><%= @filters[:date] %></span>
                </td>
                <td>
                  <% @filters[:campaigns].each do |campaign| %>
                    <span class="label label-default filter-label"><%= campaign.is_a?(Campaign) ? campaign.name : campaign %></span>
                  <% end %>
                </td>
                <td>
                  <% @filters[:topics].each do |topic| %>
                    <span class="label label-default filter-label"><%= topic %></span>
                  <% end %>
                </td>
              </tr>
            </tbody>
          </table>
      </div>
    </div>
  <% end %>
  <div class="row">
    <div class="col-md-1 col-md-offset-2">
      <button class="btn btn-default filter-collapse-btn" type="button" data-toggle="collapse" data-target="#filter" aria-expanded="false" aria-controls="filter">
        Filtros
      </button>
    </div>
    <div class="col-md-2">
      <%= link_to "Quitar filtros", user_dashboard_path, class: 'btn btn-default send-button' %>
    </div>
    <div class="col-md-2 col-md-offset-3">
      <% date = @active_filter || '1' %>
      <%= link_to "Descargar reporte", user_dashboard_path(format: :csv, nps_date: date), class: 'btn btn-default send-button', id: 'download-report' %>
    </div>
  </div>

  <br>

  <div class="row">
    <div class="col-md-8 col-md-offset-2 collapse" id="filter">
      <%= form_for :filter, url: user_dashboard_path, method: :post, html: { id: 'filter-form' } do |f| %>
        <!-- DO NOT REMOVE DATEPICKER RANGE -->
        <!-- <div class="form-group">
          <div class="input-daterange">
            <div class="row">
              <div class="col-md-6"><%#= f.text_field :start_date, class: 'form-control', placeholder: 'Fecha >= a' %></div>
              <div class="col-md-6"><%#= f.text_field :end_date, class: 'form-control', placeholder: 'Fecha <= a' %></div>
            </div>
          </div>
        </div> -->

        <table class="table table-condensed" id="filter-table">
          <thead class="container-shadow">
            <tr>
              <th class="dashboard-filter-titles">Período</th>
              <th class="dashboard-filter-titles">Campañas</th>
              <th class="dashboard-filter-titles">Topics</th>
            </tr>
          </thead>

          <tbody>
            <tr>
              <td>
                <br>
                <%= f.select :nps_date, Campaign.nps_dates.map { |key, value| [value, key] }, { selected: @active_filter }, class: 'report-select' %>
              </td>
              <td>
                <br>
                <%= button_tag 'Todas las campañas', id: 'all-campaigns' %>
                <div class="form-group" id="campaigns-checkboxes">
                  <% current_user.campaigns.each do |campaign| %>
                    <% if @selected_campaigns.size == 0 || @selected_campaigns.include?(campaign.id.to_s) %>
                      <%= check_box_tag "campaigns[]", campaign.id, { checked: true }, id: campaign.name  %>
                    <% else %>
                      <%= check_box_tag "campaigns[]", campaign.id, nil, id: campaign.name %>
                    <% end %>
                    <%= label_tag campaign.name, campaign.name, class: 'control-label', for: campaign.name %>
                    <br>
                  <% end %>
                </div>
              </td>
              <td>
                <br>
                <%= button_tag 'Todos los topics', id: 'all-topics' %>
                <div class="form-group" id="topics-checkboxes">
                  <% Campaign.contact_topics.each do |key, value| %>
                    <% if @selected_topics.include? value %>
                      <%= check_box_tag "topics[]", value, { checked: true } %>
                    <% else %>
                      <%= check_box_tag "topics[]", value, nil, id: value %>
                    <% end %>
                    <%= label_tag value, value.capitalize, class: 'control-label' %>
                    <br>
                  <% end %>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
        <div class="row">
          <div class="col-md-3 col-md-offset-4">
            <div class="form-group">
              <%= f.submit 'Filtrar', class: 'btn btn-default send-button button-100' %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <br>

  <div class="row">
    <div class="col-md-8 col-md-offset-2">
      <h1 class="dashboard-title-section">Tendencias</h1>
      <br>
      <div id="graph_report"></div>
    </div>

    <%= javascript_tag do %>
      window.graphX = <%= @nps.dates.inspect.html_safe %>
      <%=
        graph_generate(
          'graph_report',
          data: {
            x: 'x',
            columns: [
              ['x'] + @nps.dates,
              ['Cumulative NPS'] + @nps.cumulative_nps,
              ['Cumulative Detractors'] + @nps.cumulative_detractors,
              ['Cumulative Passives'] + @nps.cumulative_passives,
              ['Cumulative Promoters'] + @nps.cumulative_promoters,
              ['NPS'] + @nps.nps,
              ['Detractors'] + @nps.detractors,
              ['Passives'] + @nps.passives,
              ['Promoters'] + @nps.promoters
            ],
            # groups: [
            #   ['Cumulative NPS', 'Cumulative Detractors', 'Cumulative Passives', 'Cumulative Promoters'],
            #   ['NPS', 'Detractors', 'Passives', 'Promoters']
            # ],
            # hide:['Cumulative Detractors', 'Cumulative Passives', 'Cumulative Promoters'],
            axes: {
              'NPS' => 'y'
            }
          },
          tooltip: {
            contents: "function(d, defaultTitleFormat, defaultValueFormat, color){
                        //console.log(d);
                        var content = '<table class=\"c3-tooltip\"><tbody>';
                        content += '<tr><th colspan=\"2\">'+window.graphX[d[0].x]+'</th></tr>';

                        for(var i = 0;i<d.length;i++){
                          if($(\".c3-legend-item-Cumulative-NPS\").hasClass(\"c3-legend-item-hidden\")){
                            if(d[i].name == 'Cumulative Detractors' || d[i].name == 'Cumulative Passives' || d[i].name == 'Cumulative Promoters') continue;
                          }

                          if($(\".c3-legend-item-NPS\").hasClass(\"c3-legend-item-hidden\")){
                            if(d[i].name == 'Detractors' || d[i].name == 'Passives' || d[i].name == 'Promoters') continue;
                          }
                          var currentColor = this.levelColor ? this.levelColor(d[i].value) : color(d[i].id)
                          content += '<tr class=\"c3-tooltip-name-'+d[i].name+'\">';
                          content += '<td class=\"name\"><span style=\"background-color:'+currentColor+'\"></span>'+d[i].name+'</td>';
                          content += '<td class=\"value\">'+d[i].value+'</td></tr>';
                        }
                          content += '</tbody></table>'
                        return content;
                      }"
          },
          grid:{
            y:{
              show: true
            },
            x: {
              show: true
            }
          },
          legend: {
            hide: ['Detractors', 'Passives', 'Promoters', 'Cumulative Detractors', 'Cumulative Passives', 'Cumulative Promoters']
          },
          axis: {
            x: {
              type: 'category',
              tick: {
                rotate: 50,
                multiline: false,
                culling: {
                  max: 3
                }
              }
            },
            y: {
              max: 95,
              min: -95
            }
          },
          grid: {
            x: { show: true },
            y: { show: true }
          }
        )
      %>
    <% end %>
  </div>

  <div class="row">
    <div class="col-md-4 col-md-offset-2">
      <h1>
        <span class="label label-default">
          <span id="selected-date-feedback">30 Day NPS</span>:
          <% if @nps_30_fixed %>
            <%= (@data_percentages_30_fixed[:promoters] - @data_percentages_30_fixed[:detractors]).round %>
          <% else %>
            <%= (@data_percentages[:promoters] - @data_percentages[:detractors]).round %>
          <% end %>
        </span>
      </h1>
    </div>
  </div>

  <div id="contacts-feedback"><%= render partial: 'feedback' %></div>
<% end %>

